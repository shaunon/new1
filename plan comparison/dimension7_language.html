<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language</title>
    <link rel="stylesheet" href="common.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/extension/dataTool.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Main Charts Row -->
        <div class="charts-row">
            <!-- Grouped Bar Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Average Engagement Rate by Language</div>
                    <div class="chart-controls">
                        <button class="download-btn" onclick="downloadChart('languageBarChart')" title="Download Chart">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="languageBarChart" class="chart"></div>
            </div>

            <!-- Map + Pie Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Global Views Distribution by Language</div>
                    <div class="chart-controls">
                        <div class="toggle-buttons" id="mapToggle">
                            <button class="toggle-btn active" data-plan="planA">Plan A</button>
                            <button class="toggle-btn" data-plan="planB">Plan B</button>
                        </div>
                        <button class="download-btn" onclick="downloadChart('mapPieChart')" title="Download Chart">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="mapPieChart" class="chart"></div>
            </div>
        </div>

        <!-- Secondary Charts Grid -->
        <div class="charts-grid">
            <!-- Stacked Bar Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Language Share by Period</div>
                    <div class="chart-controls">
                        <button class="download-btn" onclick="downloadChart('stackedBarChart')" title="Download Chart">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="stackedBarChart" class="chart"></div>
            </div>

            <!-- Line + Forecast Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Engagement Rate Trend with Forecast</div>
                    <div class="chart-controls">
                        <button class="download-btn" onclick="downloadChart('forecastChart')" title="Download Chart">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="forecastChart" class="chart"></div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="data-section">
            <div class="section-header">
                <div class="section-title">Language Performance Data</div>
                <button class="download-btn" onclick="downloadTableData('dataTable')" title="Download Table Data">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    Download CSV
                </button>
            </div>
            <div class="data-table-container">
                <table class="data-table" id="dataTable">
                    <thead>
                        <tr>
                            <th>Plan</th>
                            <th>Language</th>
                            <th>Posts</th>
                            <th>Avg Views</th>
                            <th>Avg Views QoQ</th>
                            <th>Avg ER</th>
                            <th>Avg ER QoQ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Plan A data -->
                        <tr>
                            <td rowspan="8">Plan A</td>
                            <td>English</td>
                            <td>450</td>
                            <td>125,000</td>
                            <td class="metric-change positive">▲6.8%</td>
                            <td>5.2%</td>
                            <td class="metric-change positive">▲5.7%</td>
                        </tr>
                        <tr>
                            <td>Spanish</td>
                            <td>320</td>
                            <td>98,500</td>
                            <td class="metric-change positive">▲5.2%</td>
                            <td>4.8%</td>
                            <td class="metric-change positive">▲4.5%</td>
                        </tr>
                        <tr>
                            <td>Portuguese</td>
                            <td>280</td>
                            <td>85,200</td>
                            <td class="metric-change positive">▲4.8%</td>
                            <td>4.5%</td>
                            <td class="metric-change positive">▲3.8%</td>
                        </tr>
                        <tr>
                            <td>French</td>
                            <td>210</td>
                            <td>72,500</td>
                            <td class="metric-change positive">▲3.5%</td>
                            <td>4.2%</td>
                            <td class="metric-change positive">▲2.9%</td>
                        </tr>
                        <tr>
                            <td>German</td>
                            <td>180</td>
                            <td>68,200</td>
                            <td class="metric-change positive">▲2.8%</td>
                            <td>3.9%</td>
                            <td class="metric-change positive">▲2.2%</td>
                        </tr>
                        <tr>
                            <td>Italian</td>
                            <td>150</td>
                            <td>62,800</td>
                            <td class="metric-change positive">▲1.5%</td>
                            <td>3.7%</td>
                            <td class="metric-change positive">▲1.8%</td>
                        </tr>
                        <tr>
                            <td>Japanese</td>
                            <td>120</td>
                            <td>58,500</td>
                            <td class="metric-change negative">▼0.8%</td>
                            <td>3.5%</td>
                            <td class="metric-change negative">▼1.2%</td>
                        </tr>
                        <tr>
                            <td>Korean</td>
                            <td>90</td>
                            <td>52,200</td>
                            <td class="metric-change negative">▼1.5%</td>
                            <td>3.2%</td>
                            <td class="metric-change negative">▼2.1%</td>
                        </tr>
                        <!-- Plan B data -->
                        <tr>
                            <td rowspan="8">Plan B</td>
                            <td>English</td>
                            <td>420</td>
                            <td>118,000</td>
                            <td class="metric-change positive">▲5.5%</td>
                            <td>4.9%</td>
                            <td class="metric-change positive">▲4.8%</td>
                        </tr>
                        <tr>
                            <td>Spanish</td>
                            <td>300</td>
                            <td>92,500</td>
                            <td class="metric-change positive">▲4.8%</td>
                            <td>4.5%</td>
                            <td class="metric-change positive">▲3.9%</td>
                        </tr>
                        <tr>
                            <td>Portuguese</td>
                            <td>260</td>
                            <td>80,200</td>
                            <td class="metric-change positive">▲4.2%</td>
                            <td>4.2%</td>
                            <td class="metric-change positive">▲3.2%</td>
                        </tr>
                        <tr>
                            <td>French</td>
                            <td>190</td>
                            <td>68,500</td>
                            <td class="metric-change positive">▲3.0%</td>
                            <td>3.9%</td>
                            <td class="metric-change positive">▲2.5%</td>
                        </tr>
                        <tr>
                            <td>German</td>
                            <td>160</td>
                            <td>65,200</td>
                            <td class="metric-change positive">▲2.2%</td>
                            <td>3.6%</td>
                            <td class="metric-change positive">▲1.8%</td>
                        </tr>
                        <tr>
                            <td>Italian</td>
                            <td>140</td>
                            <td>60,800</td>
                            <td class="metric-change positive">▲1.2%</td>
                            <td>3.4%</td>
                            <td class="metric-change positive">▲1.5%</td>
                        </tr>
                        <tr>
                            <td>Japanese</td>
                            <td>110</td>
                            <td>55,500</td>
                            <td class="metric-change negative">▼1.2%</td>
                            <td>3.2%</td>
                            <td class="metric-change negative">▼1.8%</td>
                        </tr>
                        <tr>
                            <td>Korean</td>
                            <td>80</td>
                            <td>48,200</td>
                            <td class="metric-change negative">▼2.0%</td>
                            <td>2.9%</td>
                            <td class="metric-change negative">▼2.5%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // Initialize charts
        const languageBarChart = echarts.init(document.getElementById('languageBarChart'));
        const mapPieChart = echarts.init(document.getElementById('mapPieChart'));
        const stackedBarChart = echarts.init(document.getElementById('stackedBarChart'));
        const forecastChart = echarts.init(document.getElementById('forecastChart'));

        // Language Bar Chart
        const languageBarOption = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                formatter: function(params) {
                    const language = params[0].axisValue;
                    let html = `<div style="font-weight:bold">${language}</div>`;
                    
                    params.forEach(param => {
                        const isPlanA = param.seriesName === 'Plan A';
                        const qoq = isPlanA ? 
                            ['▲5.7%', '▲4.5%', '▲3.8%', '▲2.9%', '▲2.2%', '▲1.8%', '▼1.2%', '▼2.1%'][param.dataIndex] : 
                            ['▲4.8%', '▲3.9%', '▲3.2%', '▲2.5%', '▲1.8%', '▲1.5%', '▼1.8%', '▼2.5%'][param.dataIndex];
                        
                        const qoqColor = qoq.includes('▲') ? '#28a745' : '#dc3545';
                        
                        html += `<div style="margin-top:5px;">`;
                        html += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                        html += `${param.seriesName}: ${formatPercentage(param.value)}`;
                        html += ` <span style="color:${qoqColor}">${qoq}</span>`;
                        html += `</div>`;
                    });
                    
                    return html;
                }
            },
            legend: {
                data: ['Plan A', 'Plan B'],
                bottom: 0
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: ['English', 'Spanish', 'Portuguese', 'French', 'German', 'Italian', 'Japanese', 'Korean']
            },
            yAxis: {
                type: 'value',
                name: 'Engagement Rate',
                axisLabel: {
                    formatter: '{value}%'
                }
            },
            series: [
                {
                    name: 'Plan A',
                    type: 'bar',
                    data: [
                        {
                            value: 5.2,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲5.7%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 4.8,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲4.5%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 4.5,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲3.8%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 4.2,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲2.9%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 3.9,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲2.2%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 3.7,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲1.8%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 3.5,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▼1.2%',
                                color: '#dc3545'
                            }
                        },
                        {
                            value: 3.2,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▼2.1%',
                                color: '#dc3545'
                            }
                        }
                    ],
                    itemStyle: {
                        color: CHART_COLORS.planA
                    }
                },
                {
                    name: 'Plan B',
                    type: 'bar',
                    data: [
                        {
                            value: 4.9,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲4.8%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 4.5,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲3.9%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 4.2,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲3.2%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 3.9,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲2.5%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 3.6,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲1.8%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 3.4,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▲1.5%',
                                color: '#28a745'
                            }
                        },
                        {
                            value: 3.2,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▼1.8%',
                                color: '#dc3545'
                            }
                        },
                        {
                            value: 2.9,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '▼2.5%',
                                color: '#dc3545'
                            }
                        }
                    ],
                    itemStyle: {
                        color: CHART_COLORS.planB
                    }
                }
            ]
        };

        // Map + Pie Chart
        const generateMapPieData = (plan) => {
            const mapData = [
                { name: 'United States', value: plan === 'Plan A' ? 125000 : 118000, qoq: plan === 'Plan A' ? '▲6.8%' : '▲5.5%' },
                { name: 'Mexico', value: plan === 'Plan A' ? 98500 : 92500, qoq: plan === 'Plan A' ? '▲5.2%' : '▲4.8%' },
                { name: 'Brazil', value: plan === 'Plan A' ? 85200 : 80200, qoq: plan === 'Plan A' ? '▲4.8%' : '▲4.2%' },
                { name: 'France', value: plan === 'Plan A' ? 72500 : 68500, qoq: plan === 'Plan A' ? '▲3.5%' : '▲3.0%' },
                { name: 'Germany', value: plan === 'Plan A' ? 68200 : 65200, qoq: plan === 'Plan A' ? '▲2.8%' : '▲2.2%' },
                { name: 'Italy', value: plan === 'Plan A' ? 62800 : 60800, qoq: plan === 'Plan A' ? '▲1.5%' : '▲1.2%' },
                { name: 'Japan', value: plan === 'Plan A' ? 58500 : 55500, qoq: plan === 'Plan A' ? '▼0.8%' : '▼1.2%' },
                { name: 'South Korea', value: plan === 'Plan A' ? 52200 : 48200, qoq: plan === 'Plan A' ? '▼1.5%' : '▼2.0%' },
                { name: 'United Kingdom', value: plan === 'Plan A' ? 48500 : 45200, qoq: plan === 'Plan A' ? '▲2.5%' : '▲2.0%' },
                { name: 'Spain', value: plan === 'Plan A' ? 45800 : 42500, qoq: plan === 'Plan A' ? '▲3.2%' : '▲2.8%' },
                { name: 'Canada', value: plan === 'Plan A' ? 42500 : 40200, qoq: plan === 'Plan A' ? '▲2.8%' : '▲2.5%' },
                { name: 'Australia', value: plan === 'Plan A' ? 38200 : 36500, qoq: plan === 'Plan A' ? '▲1.8%' : '▲1.5%' }
            ];
            
            const pieData = [
                { name: 'English', value: plan === 'Plan A' ? 45 : 42, qoq: plan === 'Plan A' ? '▲5.7%' : '▲4.8%' },
                { name: 'Spanish', value: plan === 'Plan A' ? 32 : 30, qoq: plan === 'Plan A' ? '▲4.5%' : '▲3.9%' },
                { name: 'Portuguese', value: plan === 'Plan A' ? 28 : 26, qoq: plan === 'Plan A' ? '▲3.8%' : '▲3.2%' },
                { name: 'French', value: plan === 'Plan A' ? 21 : 19, qoq: plan === 'Plan A' ? '▲2.9%' : '▲2.5%' },
                { name: 'German', value: plan === 'Plan A' ? 18 : 16, qoq: plan === 'Plan A' ? '▲2.2%' : '▲1.8%' },
                { name: 'Italian', value: plan === 'Plan A' ? 15 : 14, qoq: plan === 'Plan A' ? '▲1.8%' : '▲1.5%' },
                { name: 'Japanese', value: plan === 'Plan A' ? 12 : 11, qoq: plan === 'Plan A' ? '▼1.2%' : '▼1.8%' },
                { name: 'Korean', value: plan === 'Plan A' ? 9 : 8, qoq: plan === 'Plan A' ? '▼2.1%' : '▼2.5%' }
            ];
            
            return { mapData, pieData };
        };

        const { mapData: planAMapData, pieData: planAPieData } = generateMapPieData('Plan A');
        const { mapData: planBMapData, pieData: planBPieData } = generateMapPieData('Plan B');

        const mapPieOption = {
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (params.seriesType === 'map') {
                        const qoqColor = params.data && params.data.qoq && params.data.qoq.includes('▲') ? '#28a745' : '#dc3545';
                        return `
                            <div style="font-weight:bold">${params.name}</div>
                            <div>Views: ${params.data ? formatNumber(params.data.value) : 'N/A'}</div>
                            <div>QoQ: <span style="color:${qoqColor}">${params.data ? params.data.qoq : 'N/A'}</span></div>
                        `;
                    } else {
                        const qoqColor = params.data.qoq.includes('▲') ? '#28a745' : '#dc3545';
                        return `
                            <div style="font-weight:bold">${params.name}</div>
                            <div>Share: ${params.percent.toFixed(1)}%</div>
                            <div>QoQ: <span style="color:${qoqColor}">${params.data.qoq}</span></div>
                        `;
                    }
                }
            },
            grid: [
                { right: '55%' }
            ],
            visualMap: {
                left: 'right',
                min: 30000,
                max: 130000,
                inRange: {
                    color: ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695']
                },
                text: ['High', 'Low'],
                calculable: true,
                dimension: 0,
                seriesIndex: 0
            },
            geo: {
                map: 'world',
                roam: true,
                emphasis: {
                    label: {
                        show: false
                    },
                    itemStyle: {
                        areaColor: '#eee'
                    }
                },
                itemStyle: {
                    areaColor: '#f7f7f7',
                    borderColor: '#ddd'
                }
            },
            series: [
                {
                    name: 'Views',
                    type: 'map',
                    map: 'world',
                    roam: true,
                    emphasis: {
                        label: {
                            show: false
                        }
                    },
                    data: planAMapData
                },
                {
                    name: 'Language Share',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['80%', '50%'],
                    label: {
                        show: true,
                        formatter: '{b}: {d}%'
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    data: planAPieData
                }
            ]
        };

        // Stacked Bar Chart
        const stackedBarOption = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                formatter: function(params) {
                    const language = params[0].axisValue;
                    let html = `<div style="font-weight:bold">${language}</div>`;
                    
                    params.forEach(param => {
                        const isPlanA = param.seriesName.includes('Plan A');
                        const period = param.seriesName.includes('Current') ? 'Current' : 'Previous';
                        
                        // Only show QoQ for current period
                        if (period === 'Current') {
                            const qoq = isPlanA ? 
                                ['▲5.7%', '▲4.5%', '▲3.8%', '▲2.9%', '▲2.2%', '▲1.8%', '▼1.2%', '▼2.1%'][param.dataIndex] : 
                                ['▲4.8%', '▲3.9%', '▲3.2%', '▲2.5%', '▲1.8%', '▲1.5%', '▼1.8%', '▼2.5%'][param.dataIndex];
                            
                            const qoqColor = qoq.includes('▲') ? '#28a745' : '#dc3545';
                            
                            html += `<div style="margin-top:5px;">`;
                            html += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                            html += `${param.seriesName}: ${param.value}%`;
                            html += ` <span style="color:${qoqColor}">${qoq}</span>`;
                            html += `</div>`;
                        } else {
                            html += `<div style="margin-top:5px;">`;
                            html += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                            html += `${param.seriesName}: ${param.value}%`;
                            html += `</div>`;
                        }
                    });
                    
                    return html;
                }
            },
            legend: {
                data: ['Plan A (Current)', 'Plan A (Previous)', 'Plan B (Current)', 'Plan B (Previous)'],
                bottom: 0
            },
            grid: {
                left: '3%',
                right: '15%',
                bottom: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'value',
                axisLabel: {
                    formatter: '{value}%'
                }
            },
            yAxis: {
                type: 'category',
                data: ['English', 'Spanish', 'Portuguese', 'French', 'German', 'Italian', 'Japanese', 'Korean']
            },
            series: [
                {
                    name: 'Plan A (Current)',
                    type: 'bar',
                    stack: 'Plan A',
                    emphasis: {
                        focus: 'series'
                    },
                    data: [45, 32, 28, 21, 18, 15, 12, 9],
                    itemStyle: {
                        color: CHART_COLORS.planA
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: function(params) {
                            const qoq = ['▲5.7%', '▲4.5%', '▲3.8%', '▲2.9%', '▲2.2%', '▲1.8%', '▼1.2%', '▼2.1%'][params.dataIndex];
                            return qoq;
                        },
                        color: function(params) {
                            const qoq = ['▲5.7%', '▲4.5%', '▲3.8%', '▲2.9%', '▲2.2%', '▲1.8%', '▼1.2%', '▼2.1%'][params.dataIndex];
                            return qoq.includes('▲') ? '#28a745' : '#dc3545';
                        }
                    }
                },
                {
                    name: 'Plan A (Previous)',
                    type: 'bar',
                    stack: 'Plan A',
                    emphasis: {
                        focus: 'series'
                    },
                    data: [42, 30, 27, 20, 17, 14, 12, 9],
                    itemStyle: {
                        color: CHART_COLORS.planALight
                    }
                },
                {
                    name: 'Plan B (Current)',
                    type: 'bar',
                    stack: 'Plan B',
                    emphasis: {
                        focus: 'series'
                    },
                    data: [42, 30, 26, 19, 16, 14, 11, 8],
                    itemStyle: {
                        color: CHART_COLORS.planB
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: function(params) {
                            const qoq = ['▲4.8%', '▲3.9%', '▲3.2%', '▲2.5%', '▲1.8%', '▲1.5%', '▼1.8%', '▼2.5%'][params.dataIndex];
                            return qoq;
                        },
                        color: function(params) {
                            const qoq = ['▲4.8%', '▲3.9%', '▲3.2%', '▲2.5%', '▲1.8%', '▲1.5%', '▼1.8%', '▼2.5%'][params.dataIndex];
                            return qoq.includes('▲') ? '#28a745' : '#dc3545';
                        }
                    }
                },
                {
                    name: 'Plan B (Previous)',
                    type: 'bar',
                    stack: 'Plan B',
                    emphasis: {
                        focus: 'series'
                    },
                    data: [40, 29, 25, 18, 15, 13, 11, 8],
                    itemStyle: {
                        color: CHART_COLORS.planBLight
                    }
                }
            ]
        };

        // Forecast Chart
        const forecastOption = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                },
                formatter: function(params) {
                    const period = params[0].axisValue;
                    let html = `<div style="font-weight:bold">${period}</div>`;
                    
                    params.forEach(param => {
                        const isPlanA = param.seriesName === 'Plan A';
                        const isForecast = ['Q3', 'Q4'].includes(period);
                        
                        if (!isForecast) {
                            const qoq = isPlanA ? 
                                period === 'Q1' ? '▲5.7%' : '▲4.2%' : 
                                period === 'Q1' ? '▲4.8%' : '▲3.5%';
                            
                            const qoqColor = qoq.includes('▲') ? '#28a745' : '#dc3545';
                            
                            html += `<div style="margin-top:5px;">`;
                            html += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                            html += `${param.seriesName}: ${formatPercentage(param.value)}`;
                            html += ` <span style="color:${qoqColor}">${qoq}</span>`;
                            html += `</div>`;
                        } else {
                            html += `<div style="margin-top:5px;">`;
                            html += `<span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${param.color};"></span>`;
                            html += `${param.seriesName} (Forecast): ${formatPercentage(param.value)}`;
                            html += `</div>`;
                        }
                    });
                    
                    return html;
                }
            },
            legend: {
                data: ['Plan A', 'Plan B'],
                bottom: 0
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: ['Q-2', 'Q-1', 'Q1', 'Q2', 'Q3', 'Q4']
            },
            yAxis: {
                type: 'value',
                name: 'Engagement Rate',
                axisLabel: {
                    formatter: '{value}%'
                }
            },
            series: [
                {
                    name: 'Plan A',
                    type: 'line',
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: CHART_COLORS.planA
                    },
                    data: [
                        4.2, 4.5, 
                        {
                            value: 4.8,
                            label: {
                                show: true,
                                formatter: '▲5.7%',
                                color: '#28a745',
                                position: 'top'
                            }
                        },
                        {
                            value: 5.0,
                            label: {
                                show: true,
                                formatter: '▲4.2%',
                                color: '#28a745',
                                position: 'top'
                            }
                        },
                        5.2, 5.4
                    ],
                    markLine: {
                        silent: true,
                        lineStyle: {
                            color: '#333',
                            type: 'dashed'
                        },
                        data: [
                            {
                                xAxis: 'Q2',
                                label: {
                                    formatter: 'Forecast →',
                                    position: 'middle'
                                }
                            }
                        ]
                    },
                    areaStyle: {
                        opacity: 0.3,
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            {
                                offset: 0,
                                color: CHART_COLORS.planA
                            },
                            {
                                offset: 1,
                                color: 'rgba(0, 0, 0, 0)'
                            }
                        ])
                    }
                },
                {
                    name: 'Plan B',
                    type: 'line',
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: CHART_COLORS.planB
                    },
                    data: [
                        3.9, 4.2, 
                        {
                            value: 4.5,
                            label: {
                                show: true,
                                formatter: '▲4.8%',
                                color: '#28a745',
                                position: 'bottom'
                            }
                        },
                        {
                            value: 4.7,
                            label: {
                                show: true,
                                formatter: '▲3.5%',
                                color: '#28a745',
                                position: 'bottom'
                            }
                        },
                        4.9, 5.0
                    ],
                    areaStyle: {
                        opacity: 0.3,
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            {
                                offset: 0,
                                color: CHART_COLORS.planB
                            },
                            {
                                offset: 1,
                                color: 'rgba(0, 0, 0, 0)'
                            }
                        ])
                    }
                }
            ]
        };

        // Set chart options
        languageBarChart.setOption(languageBarOption);
        mapPieChart.setOption(mapPieOption);
        stackedBarChart.setOption(stackedBarOption);
        forecastChart.setOption(forecastOption);

        // Setup map toggle
        document.querySelectorAll('#mapToggle .toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#mapToggle .toggle-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const plan = this.getAttribute('data-plan');
                
                if (plan === 'planA') {
                    mapPieOption.series[0].data = planAMapData;
                    mapPieOption.series[1].data = planAPieData;
                } else {
                    mapPieOption.series[0].data = planBMapData;
                    mapPieOption.series[1].data = planBPieData;
                }
                
                mapPieChart.setOption(mapPieOption);
            });
        });

        // Resize charts when window is resized
        window.addEventListener('resize', function() {
            languageBarChart.resize();
            mapPieChart.resize();
            stackedBarChart.resize();
            forecastChart.resize();
        });
    </script>
</body>
</html>