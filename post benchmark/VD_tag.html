<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            padding: 20px;
        }

        .chart-section {
            margin-bottom: 40px;
        }

        .chart-container {
            height: 500px;
            width: 100%;
            margin-bottom: 20px;
        }

        .chart {
            width: 100%;
            height: 100%;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn.active {
            background-color: #28a745;
        }

        .data-table-container {
            margin-top: 30px;
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .hashtag-name {
            font-weight: 600;
            color: #007bff;
        }

        .duration-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            background-color: #e9ecef;
            color: #495057;
        }

        @media (max-width: 768px) {
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 200px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Word Cloud / Sunburst Chart Section -->
    <div class="chart-section">
        <h2 style="text-align: center; margin-bottom: 15px; color: #333;">Hashtag Visualization by Video Duration</h2>
        <div class="control-buttons">
            <button class="btn active" id="wordcloudBtn">Word Cloud</button>
            <button class="btn" id="sunburstBtn">Sunburst Chart</button>
        </div>
        <div class="chart-container">
            <div id="visualChart" class="chart"></div>
        </div>
    </div>

    <!-- Bar and Line Chart Section -->
    <div class="chart-section">
        <h2 style="text-align: center; margin-bottom: 15px; color: #333;">Hashtag Performance Metrics</h2>
        <div class="control-buttons">
            <label for="metricSelector" style="margin-right: 10px; font-weight: 600;">Select Metric:</label>
            <select id="metricSelector" class="btn" style="padding: 8px 15px; background-color: #007bff; color: white; border: none; border-radius: 6px;">
                <option value="engagement">Engagement</option>
                <option value="views">Views</option>
                <option value="engagementRate">Engagement Rate</option>
            </select>
        </div>
        <div class="chart-container">
            <div id="barLineChart" class="chart"></div>
        </div>
    </div>

    <!-- Data Table Section -->
    <div class="data-table-container">
        <h2 style="text-align: center; margin-bottom: 15px; color: #333;">Top Hashtags Data Table</h2>
        <div class="table-wrapper">
            <table id="hashtagTable">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Hashtag</th>
                        <th>Video Duration</th>
                        <th>Usage Count</th>
                        <th>Engagement</th>
                        <th>Views</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Sample hashtag data organized by hashtag
        const hashtagData = {
            '#fashion': {
                '0~15s': {count: 15420, engagement: 892000, views: 2840000},
                '15~30s': {count: 12800, engagement: 756000, views: 2100000},
                '30~60s': {count: 11200, engagement: 634000, views: 1890000},
                '1~3min': {count: 9800, engagement: 587000, views: 1650000},
                '3~5min': {count: 8900, engagement: 523000, views: 1420000},
                '5~10min': {count: 7600, engagement: 445000, views: 1280000},
                '10~20min': {count: 6800, engagement: 398000, views: 1150000},
                '20~30min': {count: 6200, engagement: 364000, views: 1050000},
                '30~60min': {count: 5800, engagement: 340000, views: 980000},
                '>60min': {count: 5400, engagement: 316000, views: 920000}
            },
            '#style': {
                '0~15s': {count: 12800, engagement: 756000, views: 2100000},
                '15~30s': {count: 11200, engagement: 634000, views: 1890000},
                '30~60s': {count: 9800, engagement: 587000, views: 1650000},
                '1~3min': {count: 8900, engagement: 523000, views: 1420000},
                '3~5min': {count: 7600, engagement: 445000, views: 1280000},
                '5~10min': {count: 6800, engagement: 398000, views: 1150000},
                '10~20min': {count: 6200, engagement: 364000, views: 1050000},
                '20~30min': {count: 5800, engagement: 340000, views: 980000},
                '30~60min': {count: 5400, engagement: 316000, views: 920000},
                '>60min': {count: 4900, engagement: 287000, views: 830000}
            },
            '#ootd': {
                '0~15s': {count: 11200, engagement: 634000, views: 1890000},
                '15~30s': {count: 9800, engagement: 587000, views: 1650000},
                '30~60s': {count: 8900, engagement: 523000, views: 1420000},
                '1~3min': {count: 7600, engagement: 445000, views: 1280000},
                '3~5min': {count: 6800, engagement: 398000, views: 1150000},
                '5~10min': {count: 6200, engagement: 364000, views: 1050000},
                '10~20min': {count: 5800, engagement: 340000, views: 980000},
                '20~30min': {count: 5400, engagement: 316000, views: 920000},
                '30~60min': {count: 4900, engagement: 287000, views: 830000},
                '>60min': {count: 4500, engagement: 263000, views: 760000}
            },
            '#beauty': {
                '0~15s': {count: 9800, engagement: 587000, views: 1650000},
                '15~30s': {count: 8900, engagement: 523000, views: 1420000},
                '30~60s': {count: 7600, engagement: 445000, views: 1280000},
                '1~3min': {count: 6800, engagement: 398000, views: 1150000},
                '3~5min': {count: 6200, engagement: 364000, views: 1050000},
                '5~10min': {count: 5800, engagement: 340000, views: 980000},
                '10~20min': {count: 5400, engagement: 316000, views: 920000},
                '20~30min': {count: 4900, engagement: 287000, views: 830000},
                '30~60min': {count: 4500, engagement: 263000, views: 760000},
                '>60min': {count: 4200, engagement: 246000, views: 710000}
            },
            '#makeup': {
                '0~15s': {count: 8900, engagement: 523000, views: 1420000},
                '15~30s': {count: 7600, engagement: 445000, views: 1280000},
                '30~60s': {count: 6800, engagement: 398000, views: 1150000},
                '1~3min': {count: 6200, engagement: 364000, views: 1050000},
                '3~5min': {count: 5800, engagement: 340000, views: 980000},
                '5~10min': {count: 5400, engagement: 316000, views: 920000},
                '10~20min': {count: 4900, engagement: 287000, views: 830000},
                '20~30min': {count: 4500, engagement: 263000, views: 760000},
                '30~60min': {count: 4200, engagement: 246000, views: 710000},
                '>60min': {count: 3800, engagement: 222000, views: 640000}
            },
            '#skincare': {
                '0~15s': {count: 7600, engagement: 445000, views: 1280000},
                '15~30s': {count: 6800, engagement: 398000, views: 1150000},
                '30~60s': {count: 6200, engagement: 364000, views: 1050000},
                '1~3min': {count: 5800, engagement: 340000, views: 980000},
                '3~5min': {count: 5400, engagement: 316000, views: 920000},
                '5~10min': {count: 4900, engagement: 287000, views: 830000},
                '10~20min': {count: 4500, engagement: 263000, views: 760000},
                '20~30min': {count: 4200, engagement: 246000, views: 710000},
                '30~60min': {count: 3800, engagement: 222000, views: 640000},
                '>60min': {count: 3500, engagement: 205000, views: 590000}
            },
            '#trending': {
                '0~15s': {count: 6800, engagement: 398000, views: 1150000},
                '15~30s': {count: 6200, engagement: 364000, views: 1050000},
                '30~60s': {count: 5800, engagement: 340000, views: 980000},
                '1~3min': {count: 5400, engagement: 316000, views: 920000},
                '3~5min': {count: 4900, engagement: 287000, views: 830000},
                '5~10min': {count: 4500, engagement: 263000, views: 760000},
                '10~20min': {count: 4200, engagement: 246000, views: 710000},
                '20~30min': {count: 3800, engagement: 222000, views: 640000},
                '30~60min': {count: 3500, engagement: 205000, views: 590000},
                '>60min': {count: 3200, engagement: 187000, views: 540000}
            },
            '#viral': {
                '0~15s': {count: 6200, engagement: 364000, views: 1050000},
                '15~30s': {count: 5800, engagement: 340000, views: 980000},
                '30~60s': {count: 5400, engagement: 316000, views: 920000},
                '1~3min': {count: 4900, engagement: 287000, views: 830000},
                '3~5min': {count: 4500, engagement: 263000, views: 760000},
                '5~10min': {count: 4200, engagement: 246000, views: 710000},
                '10~20min': {count: 3800, engagement: 222000, views: 640000},
                '20~30min': {count: 3500, engagement: 205000, views: 590000},
                '30~60min': {count: 3200, engagement: 187000, views: 540000},
                '>60min': {count: 2900, engagement: 170000, views: 490000}
            },
            '#lifestyle': {
                '0~15s': {count: 5800, engagement: 340000, views: 980000},
                '15~30s': {count: 5400, engagement: 316000, views: 920000},
                '30~60s': {count: 4900, engagement: 287000, views: 830000},
                '1~3min': {count: 4500, engagement: 263000, views: 760000},
                '3~5min': {count: 4200, engagement: 246000, views: 710000},
                '5~10min': {count: 3800, engagement: 222000, views: 640000},
                '10~20min': {count: 3500, engagement: 205000, views: 590000},
                '20~30min': {count: 3200, engagement: 187000, views: 540000},
                '30~60min': {count: 2900, engagement: 170000, views: 490000},
                '>60min': {count: 2600, engagement: 152000, views: 440000}
            }
        };

        // Duration categories for reference
        const durationCategories = ['0~15s', '15~30s', '30~60s', '1~3min', '3~5min', '5~10min', '10~20min', '20~30min', '30~60min', '>60min'];

        // Generate color palette for different durations
        const durationColors = {
            '0~15s': '#FF6B6B',
            '15~30s': '#4ECDC4',
            '30~60s': '#45B7D1',
            '1~3min': '#96CEB4',
            '3~5min': '#FFEAA7',
            '5~10min': '#DDA0DD',
            '10~20min': '#98D8C8',
            '20~30min': '#F7DC6F',
            '30~60min': '#BB8FCE',
            '>60min': '#85C1E9'
        };

        // Initialize charts
        let visualChart = echarts.init(document.getElementById('visualChart'));
        let barLineChart = echarts.init(document.getElementById('barLineChart'));

        // Prepare word cloud data by duration with positioning
        function prepareWordCloudByDuration() {
            const cloudData = [];
            const hashtags = Object.keys(hashtagData);
            const gridCols = 3; // 3 columns
            const gridRows = Math.ceil(durationCategories.length / gridCols);
            
            durationCategories.forEach((duration, index) => {
                const row = Math.floor(index / gridCols);
                const col = index % gridCols;
                
                // Calculate position for each duration group
                const left = (col * 33) + 5; // 33% width per column with 5% margin
                const top = (row * 50) + 5;  // 50% height per row with 5% margin
                const width = 28; // 28% width
                const height = 40; // 40% height
                
                // Get hashtags for this duration and sort by count
                const durationHashtags = [];
                hashtags.forEach(hashtag => {
                    if (hashtagData[hashtag][duration]) {
                        durationHashtags.push({
                            name: hashtag,
                            count: hashtagData[hashtag][duration].count
                        });
                    }
                });
                
                const topHashtags = durationHashtags
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 15) // Top 15 per duration
                    .map(item => ({
                        name: item.name,
                        value: item.count,
                        textStyle: {
                            color: durationColors[duration]
                        }
                    }));
                
                cloudData.push({
                    type: 'wordCloud',
                    left: left + '%',
                    top: top + '%',
                    width: width + '%',
                    height: height + '%',
                    gridSize: 2,
                    sizeRange: [8, 24],
                    rotationRange: [-45, 45],
                    shape: 'circle',
                    drawOutOfBound: false,
                    textStyle: {
                        fontFamily: 'sans-serif',
                        fontWeight: 'bold'
                    },
                    emphasis: {
                        textStyle: {
                            shadowBlur: 5,
                            shadowColor: '#333'
                        }
                    },
                    data: topHashtags
                });
            });
            
            return cloudData;
        }

        // Prepare data for sunburst chart
        function prepareSunburstData() {
            let sunburstData = [];
            durationCategories.forEach(duration => {
                let children = [];
                
                // Get hashtags for this duration and sort by count
                Object.keys(hashtagData).forEach(hashtag => {
                    if (hashtagData[hashtag][duration]) {
                        children.push({
                            name: hashtag,
                            value: hashtagData[hashtag][duration].count,
                            itemStyle: {
                                color: durationColors[duration]
                            }
                        });
                    }
                });
                
                // Sort and take top 10
                children = children.sort((a, b) => b.value - a.value).slice(0, 10);
                
                sunburstData.push({
                    name: duration,
                    children: children,
                    itemStyle: {
                        color: durationColors[duration]
                    }
                });
            });
            return sunburstData;
        }

        // Toggle between word cloud and sunburst chart
        let isWordCloud = true;
        
        function toggleChart() {
            isWordCloud = !isWordCloud;
            const button = document.getElementById('toggleButton');
            button.textContent = isWordCloud ? 'Switch to Sunburst' : 'Switch to Word Cloud';
            
            // Clear the chart first to prevent overlap
            visualChart.clear();
            
            if (isWordCloud) {
                visualChart.setOption(wordCloudOption, true);
            } else {
                visualChart.setOption(sunburstOption, true);
            }
        }

        // Word Cloud Chart with duration zones
        const wordCloudOption = {
            title: durationCategories.map((duration, index) => {
                const row = Math.floor(index / 3);
                const col = index % 3;
                const left = (col * 33) + 5;
                const top = (row * 50) + 2;
                
                return {
                    text: duration,
                    left: left + '%',
                    top: top + '%',
                    textStyle: {
                        color: durationColors[duration],
                        fontSize: 12,
                        fontWeight: 'bold'
                    }
                };
            }),
            tooltip: {
                formatter: function(params) {
                    return `${params.name}: ${params.value.toLocaleString()} uses`;
                }
            },
            series: prepareWordCloudByDuration()
        };

        // Sunburst Chart
        const sunburstOption = {
            tooltip: {
                formatter: function(params) {
                    return `${params.name}: ${params.value.toLocaleString()} uses`;
                }
            },
            series: {
                type: 'sunburst',
                data: prepareSunburstData(),
                radius: [0, '90%'],
                itemStyle: {
                    borderRadius: 7,
                    borderWidth: 2
                },
                label: {
                    show: true,
                    rotate: 'radial',
                    fontSize: 10,
                    fontWeight: 'bold',
                    color: '#fff',
                    textShadowColor: 'rgba(0, 0, 0, 0.5)',
                    textShadowBlur: 2
                },
                emphasis: {
                    focus: 'ancestor',
                    label: {
                        fontSize: 12,
                        fontWeight: 'bold'
                    }
                }
            }
        };

        // Prepare data for stacked bar chart (hashtags as X-axis, durations as series)
        function prepareStackedBarData(metric = 'engagement') {
            // Get all hashtags and calculate totals
            let allHashtags = [];
            Object.keys(hashtagData).forEach(hashtag => {
                let totalEngagement = 0;
                let totalViews = 0;
                let totalCount = 0;
                
                Object.keys(hashtagData[hashtag]).forEach(duration => {
                    const data = hashtagData[hashtag][duration];
                    totalEngagement += data.engagement;
                    totalViews += data.views;
                    totalCount += data.count;
                });
                
                allHashtags.push({
                    name: hashtag,
                    totalEngagement: totalEngagement,
                    totalViews: totalViews,
                    totalCount: totalCount
                });
            });
            
            // Sort by the selected metric and get top 5
            let sortKey = 'totalEngagement';
            if (metric === 'views') sortKey = 'totalViews';
            else if (metric === 'engagementRate') sortKey = 'totalEngagement'; // We'll calculate rate later
            
            const top5Hashtags = allHashtags.sort((a, b) => b[sortKey] - a[sortKey]).slice(0, 5);
            
            // Prepare data for each duration across selected hashtags
            const seriesData = {};
            
            durationCategories.forEach(duration => {
                seriesData[duration] = [];
                
                top5Hashtags.forEach(hashtag => {
                    const found = hashtagData[hashtag.name] && hashtagData[hashtag.name][duration];
                    if (found) {
                        let value;
                        if (metric === 'engagement') {
                            value = found.engagement;
                        } else if (metric === 'views') {
                            value = found.views;
                        } else if (metric === 'engagementRate') {
                            value = found.views > 0 ? (found.engagement / found.views * 100) : 0;
                        }
                        seriesData[duration].push(value);
                    } else {
                        seriesData[duration].push(0);
                    }
                });
            });
            
            return {
                hashtags: top5Hashtags.map(item => item.name),
                durations: durationCategories,
                seriesData: seriesData,
                metric: metric
            };
        }

        // Create chart option based on selected metric
        function createBarChartOption(metric = 'engagement') {
            const chartData = ensureCompleteData(prepareStackedBarData(metric));
            
            let yAxisName, tooltipSuffix, formatValue;
            
            if (metric === 'engagement') {
                yAxisName = 'Engagement';
                tooltipSuffix = '';
                formatValue = function(value) {
                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                    else if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                    return value;
                };
            } else if (metric === 'views') {
                yAxisName = 'Views';
                tooltipSuffix = '';
                formatValue = function(value) {
                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                    else if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                    return value;
                };
            } else if (metric === 'engagementRate') {
                yAxisName = 'Engagement Rate (%)';
                tooltipSuffix = '%';
                formatValue = function(value) {
                    return value.toFixed(2) + '%';
                };
            }
            
            return {
                title: {
                    text: '',
                    left: 'center',
                    textStyle: {
                        fontSize: 16,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(param => {
                            result += param.marker + param.seriesName + ': ' + formatValue(param.value) + '<br/>';
                        });
                        return result;
                    }
                },
                legend: {
                    data: chartData.durations,
                    type: 'scroll',
                    orient: 'horizontal',
                    top: 40
                },
                grid: {
                    top: 80,
                    bottom: 80,
                    left: 80,
                    right: 50
                },
                xAxis: {
                    type: 'category',
                    data: chartData.hashtags,
                    axisLabel: {
                        rotate: 45,
                        interval: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: yAxisName,
                    axisLabel: {
                        formatter: formatValue
                    }
                },
                series: chartData.durations.map((duration, index) => ({
                    name: duration,
                    type: 'bar',
                    stack: 'total',
                    data: chartData.seriesData[duration],
                    itemStyle: {
                        color: durationColors[duration] || `hsl(${index * 72}, 70%, 60%)`
                    }
                }))
            };
        }

        let currentMetric = 'engagement';
        const chartData = prepareStackedBarData(currentMetric);
        
        // Ensure all durations have data for all hashtags
        function ensureCompleteData(chartData) {
            chartData.durations.forEach(duration => {
                chartData.hashtags.forEach((hashtag, index) => {
                    // If data point is missing or zero, find average of neighboring points or use minimum value
                    if (!chartData.seriesData[duration][index] || chartData.seriesData[duration][index] === 0) {
                        let value = 0;
                        // Try to get average of neighboring points
                        let count = 0;
                        if (index > 0 && chartData.seriesData[duration][index-1]) {
                            value += chartData.seriesData[duration][index-1];
                            count++;
                        }
                        if (index < chartData.hashtags.length-1 && chartData.seriesData[duration][index+1]) {
                            value += chartData.seriesData[duration][index+1];
                            count++;
                        }
                        
                        // If no neighbors, use minimum value from data
                        if (count === 0) {
                            const allValues = Object.values(chartData.seriesData).flatMap(arr => arr.filter(v => v > 0));
                            const minValue = Math.min(...allValues) * 0.5;
                            chartData.seriesData[duration][index] = minValue;
                        } else {
                            chartData.seriesData[duration][index] = value / count * 0.7; // 70% of average
                        }
                    }
                });
            });
            return chartData;
        }
        

        // Set initial chart (word cloud and stacked bar chart)
        visualChart.setOption(wordCloudOption);
        barLineChart.setOption(createBarChartOption(currentMetric));

        // Button event handlers
        document.getElementById('wordcloudBtn').addEventListener('click', function() {
            // Clear the chart first to prevent overlap
            visualChart.clear();
            visualChart.setOption(wordCloudOption, true);
            document.getElementById('wordcloudBtn').classList.add('active');
            document.getElementById('sunburstBtn').classList.remove('active');
        });

        document.getElementById('sunburstBtn').addEventListener('click', function() {
            // Clear the chart first to prevent overlap
            visualChart.clear();
            visualChart.setOption(sunburstOption, true);
            document.getElementById('sunburstBtn').classList.add('active');
            document.getElementById('wordcloudBtn').classList.remove('active');
        });

        // Metric selector event handler
        document.getElementById('metricSelector').addEventListener('change', function() {
            currentMetric = this.value;
            barLineChart.setOption(createBarChartOption(currentMetric), true);
        });

        // Generate table data (top 100)
        function generateTableData() {
            let allHashtags = [];
            Object.keys(hashtagData).forEach(hashtag => {
                Object.keys(hashtagData[hashtag]).forEach(duration => {
                    const item = hashtagData[hashtag][duration];
                    allHashtags.push({
                        name: hashtag,
                        duration: duration,
                        count: item.count,
                        engagement: item.engagement,
                        views: item.views
                    });
                });
            });
            
            return allHashtags.sort((a, b) => b.count - a.count).slice(0, 100);
        }

        // Populate table
        function populateTable() {
            const tableData = generateTableData();
            const tbody = document.getElementById('tableBody');
            
            tableData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><span class="hashtag-name">${item.name}</span></td>
                    <td><span class="duration-badge">${item.duration}</span></td>
                    <td>${item.count.toLocaleString()}</td>
                    <td>${item.engagement.toLocaleString()}</td>
                    <td>${item.views.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize table
        populateTable();

        // Handle window resize
        window.addEventListener('resize', function() {
            visualChart.resize();
            barLineChart.resize();
        });
    </script>
</body>
</html>