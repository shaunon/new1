<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGM Type Country Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .data-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5em;
            color: #2c3e50;
            font-weight: 600;
        }

        .download-icon {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .download-icon:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .chart-container {
            width: 100%;
            height: 600px;
            margin-bottom: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .country-flag {
            display: inline-block;
            width: 24px;
            height: 16px;
            margin-right: 8px;
            border-radius: 2px;
            vertical-align: middle;
        }

        .country-name {
            display: flex;
            align-items: center;
        }

        .region-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            color: white;
        }

        .region-asia { background: #e74c3c; }
        .region-europe { background: #3498db; }
        .region-america { background: #27ae60; }
        .region-africa { background: #f39c12; }
        .region-oceania { background: #9b59b6; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Key Metrics -->
        <div class="data-card">
            <div class="card-header">
                <h2 class="card-title">Global BGM Metrics</h2>
                <button class="download-icon" onclick="downloadMetrics()">📊 Download</button>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value">18.7K</div>
                    <div class="metric-label">Total Posts</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">5.2M</div>
                    <div class="metric-label">Total Likes</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">1.3M</div>
                    <div class="metric-label">Total Comments</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">2.1M</div>
                    <div class="metric-label">Total Shares</div>
                </div>
            </div>
        </div>

        <!-- Global Distribution Map -->
        <div class="data-card">
            <div class="card-header">
                <h2 class="card-title">Global BGM Type Distribution</h2>
                <button class="download-icon" onclick="downloadChart('globalMap')">📊 Download</button>
            </div>
            <div id="globalMap" class="chart-container"></div>
        </div>

        <!-- Top Countries Chart -->
        <div class="data-card">
            <div class="card-header">
                <h2 class="card-title">Top Countries by BGM Posts</h2>
                <button class="download-icon" onclick="downloadChart('topCountries')">📊 Download</button>
            </div>
            <div id="topCountries" class="chart-container"></div>
        </div>

        <!-- Regional Preferences Chart -->
        <div class="data-card">
            <div class="card-header">
                <h2 class="card-title">Regional BGM Type Preferences</h2>
                <button class="download-icon" onclick="downloadChart('regionalPreferences')">📊 Download</button>
            </div>
            <div id="regionalPreferences" class="chart-container"></div>
        </div>

        <!-- Country Analysis Table -->
        <div class="data-card">
            <div class="card-header">
                <h2 class="card-title">Country Performance Analysis</h2>
                <button class="download-icon" onclick="downloadTable('countryTable')">📊 Download</button>
            </div>
            <table class="data-table" id="countryTable">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Region</th>
                        <th>Total Posts</th>
                        <th>Top BGM Type</th>
                        <th>Engagement Rate</th>
                        <th>Growth Rate</th>
                        <th>Market Share</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="country-name">
                                <span class="country-flag" style="background: linear-gradient(to bottom, #ff0000 33%, #ffffff 33%, #ffffff 66%, #ff0000 66%);"></span>
                                United States
                            </div>
                        </td>
                        <td><span class="region-badge region-america">North America</span></td>
                        <td>4,250</td>
                        <td>Pop Music</td>
                        <td>12.8%</td>
                        <td>+15.2%</td>
                        <td>22.7%</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="country-name">
                                <span class="country-flag" style="background: linear-gradient(to bottom, #ff0000 33%, #ffffff 33%, #ffffff 66%, #ff0000 66%);"></span>
                                China
                            </div>
                        </td>
                        <td><span class="region-badge region-asia">Asia</span></td>
                        <td>3,890</td>
                        <td>Electronic</td>
                        <td>18.5%</td>
                        <td>+22.1%</td>
                        <td>20.8%</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="country-name">
                                <span class="country-flag" style="background: linear-gradient(to bottom, #000000 33%, #ff0000 33%, #ff0000 66%, #ffff00 66%);"></span>
                                Germany
                            </div>
                        </td>
                        <td><span class="region-badge region-europe">Europe</span></td>
                        <td>2,650</td>
                        <td>Classical</td>
                        <td>14.2%</td>
                        <td>+8.7%</td>
                        <td>14.2%</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="country-name">
                                <span class="country-flag" style="background: linear-gradient(to bottom, #0055a4 33%, #ffffff 33%, #ffffff 66%, #ef4135 66%);"></span>
                                France
                            </div>
                        </td>
                        <td><span class="region-badge region-europe">Europe</span></td>
                        <td>2,180</td>
                        <td>Jazz</td>
                        <td>11.9%</td>
                        <td>+6.3%</td>
                        <td>11.7%</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="country-name">
                                <span class="country-flag" style="background: linear-gradient(to bottom, #ffffff 25%, #ff0000 25%, #ff0000 75%, #ffffff 75%);"></span>
                                Japan
                            </div>
                        </td>
                        <td><span class="region-badge region-asia">Asia</span></td>
                        <td>1,920</td>
                        <td>Electronic</td>
                        <td>16.4%</td>
                        <td>+12.8%</td>
                        <td>10.3%</td>
                    </tr>
                    <tr>
                        <td>
                            <div class="country-name">
                                <span class="country-flag" style="background: linear-gradient(to bottom, #009639 33%, #ffffff 33%, #ffffff 66%, #ce1126 66%);"></span>
                                Italy
                            </div>
                        </td>
                        <td><span class="region-badge region-europe">Europe</span></td>
                        <td>1,650</td>
                        <td>Classical</td>
                        <td>13.7%</td>
                        <td>+9.1%</td>
                        <td>8.8%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Cultural Trends Chart -->
        <div class="data-card">
            <div class="card-header">
                <h2 class="card-title">Cultural BGM Trends by Region</h2>
                <button class="download-icon" onclick="downloadChart('culturalTrends')">📊 Download</button>
            </div>
            <div id="culturalTrends" class="chart-container"></div>
        </div>
    </div>

    <script>
        // Initialize world map directly without external dependencies
        function initWorldMap() {
            // Register a world map with more realistic country shapes
            const worldGeoJson = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {"name": "China"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[73.5, 39.5], [96.4, 42.7], [124.3, 39.9], [127.5, 50.7], [134.8, 48.3], [134.7, 31.4], [130.8, 25.2], [108.1, 21.4], [82.3, 27.9], [78.7, 35.5], [73.5, 39.5]]]
                        }
                    },
                    {
                        "type": "Feature", 
                        "properties": {"name": "United States"},
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [[[-158.2, 21.5], [-154.8, 21.2], [-154.8, 22.2], [-158.2, 22.5], [-158.2, 21.5]]],
                                [[[-178.2, 18.9], [-154.8, 18.9], [-154.8, 28.4], [-178.2, 28.4], [-178.2, 18.9]]],
                                [[[-125.0, 32.5], [-66.9, 20.2], [-67.2, 45.0], [-125.0, 49.0], [-125.0, 32.5]]]
                            ]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Japan"},
                        "geometry": {
                            "type": "MultiPolygon", 
                            "coordinates": [
                                [[[129.4, 31.3], [130.7, 31.0], [131.9, 33.1], [133.7, 34.4], [140.9, 35.7], [141.9, 39.2], [140.6, 43.5], [139.8, 45.5], [138.0, 46.2], [132.6, 42.9], [129.4, 31.3]]],
                                [[[142.2, 43.2], [145.8, 43.9], [145.5, 44.5], [142.1, 44.2], [142.2, 43.2]]]
                            ]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Germany"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[5.9, 47.3], [15.0, 47.7], [15.0, 54.9], [9.9, 54.8], [6.2, 53.4], [5.9, 47.3]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "United Kingdom"},
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [[[-5.7, 49.9], [1.8, 50.7], [1.8, 55.8], [-5.7, 58.6], [-5.7, 49.9]]],
                                [[[-8.2, 54.7], [-5.4, 54.0], [-3.0, 58.6], [-8.2, 58.7], [-8.2, 54.7]]]
                            ]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "France"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[-4.6, 48.4], [8.2, 49.0], [7.6, 43.8], [3.0, 42.5], [-1.8, 43.4], [-4.6, 48.4]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "South Korea"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[124.6, 33.2], [129.6, 35.4], [128.3, 38.6], [125.0, 38.4], [124.6, 33.2]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Canada"},
                        "geometry": {
                            "type": "MultiPolygon",
                            "coordinates": [
                                [[[-141.0, 60.3], [-52.6, 41.7], [-52.6, 83.1], [-141.0, 83.1], [-141.0, 60.3]]],
                                [[[-95.2, 69.0], [-74.0, 62.0], [-61.8, 69.6], [-95.2, 78.0], [-95.2, 69.0]]]
                            ]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Australia"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[113.3, -43.6], [153.6, -28.2], [145.4, -9.2], [129.0, -11.2], [113.3, -43.6]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Brazil"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[-73.9, -7.4], [-34.8, 5.3], [-34.8, -33.8], [-73.9, -33.8], [-73.9, -7.4]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Russia"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[19.6, 41.2], [169.0, 64.7], [180.0, 71.5], [19.6, 81.9], [19.6, 41.2]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "India"},
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[68.2, 6.7], [97.4, 35.5], [88.2, 28.1], [68.2, 6.7]]]
                        }
                    }
                ]
            };
            
            // Register the map with ECharts
            echarts.registerMap('world', worldGeoJson);
            
            // Initialize the global map
            initGlobalMap();
        }
        
        // Initialize the map when page loads
        initWorldMap();

        function initGlobalMap() {
            const globalMapChart = echarts.init(document.getElementById('globalMap'));
            
            // BGM type color mapping
            const bgmTypeColors = {
                'Pop': '#FF6B6B',
                'Rock': '#4ECDC4', 
                'Electronic': '#45B7D1',
                'Classical': '#96CEB4',
                'Jazz': '#FFEAA7',
                'Hip-Hop': '#DDA0DD',
                'Folk': '#98D8C8',
                'Other': '#F7DC6F'
            };

            // Sample country data with BGM type information
            const countryData = [
                {name: 'China', value: 1500, bgmType: 'Pop', percentage: 45},
                {name: 'United States', value: 1200, bgmType: 'Rock', percentage: 38},
                {name: 'Japan', value: 800, bgmType: 'Electronic', percentage: 42},
                {name: 'Germany', value: 600, bgmType: 'Classical', percentage: 35},
                {name: 'United Kingdom', value: 550, bgmType: 'Rock', percentage: 40},
                {name: 'France', value: 480, bgmType: 'Pop', percentage: 33},
                {name: 'South Korea', value: 420, bgmType: 'Pop', percentage: 52},
                {name: 'Canada', value: 380, bgmType: 'Folk', percentage: 28},
                {name: 'Australia', value: 320, bgmType: 'Rock', percentage: 36},
                {name: 'Brazil', value: 290, bgmType: 'Pop', percentage: 41}
            ];

            const option = {
                title: {
                    text: 'Global BGM Type Distribution',
                    left: 'center',
                    textStyle: {
                        color: '#333',
                        fontSize: 18,
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.data) {
                            return `
                                <strong>${params.data.name}</strong><br/>
                                Total Posts: ${params.data.value}<br/>
                                Main BGM Type: <span style="color: ${bgmTypeColors[params.data.bgmType]}">${params.data.bgmType}</span><br/>
                                Percentage: ${params.data.percentage}%
                            `;
                        }
                        return params.name;
                    }
                },
                legend: {
                    orient: 'horizontal',
                    bottom: '2%',
                    left: 'center',
                    data: Object.keys(bgmTypeColors),
                    itemWidth: 15,
                    itemHeight: 10,
                    textStyle: {
                        fontSize: 12
                    },
                    formatter: function(name) {
                        return name;
                    }
                },
                visualMap: {
                    min: 0,
                    max: 1500,
                    left: '2%',
                    bottom: '15%',
                    text: ['High', 'Low'],
                    calculable: true,
                    inRange: {
                        color: ['#e0f3ff', '#006edd']
                    },
                    textStyle: {
                        fontSize: 11
                    }
                },
                geo: {
                    map: 'world',
                    roam: true,
                    zoom: 1.2,
                    center: [0, 20],
                    layoutCenter: ['50%', '50%'],
                    layoutSize: '95%',
                    aspectScale: 0.75,
                    itemStyle: {
                        areaColor: '#f5f5f5',
                        borderColor: '#ccc',
                        borderWidth: 0.8
                    },
                    emphasis: {
                        itemStyle: {
                            areaColor: '#389BB7',
                            borderColor: '#333',
                            borderWidth: 1.5,
                            shadowBlur: 15,
                            shadowColor: 'rgba(0, 0, 0, 0.4)'
                        }
                    },
                    label: {
                        show: false,
                        fontSize: 10,
                        color: '#666'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 12,
                            color: '#fff'
                        }
                    }
                },
                series: [
                    {
                        name: 'BGM Posts',
                        type: 'map',
                        geoIndex: 0,
                        data: countryData.map(item => ({
                            ...item,
                            itemStyle: {
                                areaColor: bgmTypeColors[item.bgmType] || '#ccc'
                            }
                        }))
                    }
                ]
            };

            globalMapChart.setOption(option);
            
            // Handle window resize
            window.addEventListener('resize', function() {
                globalMapChart.resize();
            });
        }

        function initSimplifiedWorldMap() {
            const globalMapChart = echarts.init(document.getElementById('globalMap'));
            
            // BGM type color mapping
            const bgmTypeColors = {
                'Pop Music': '#ff6b6b',
                'Electronic': '#4ecdc4', 
                'Classical': '#45b7d1',
                'Jazz': '#f9ca24',
                'Rock': '#6c5ce7',
                'Hip Hop': '#fd79a8',
                'Folk': '#00b894',
                'R&B': '#e17055'
            };
            
            // Simplified world map using built-in ECharts world map
            const simplifiedWorldGeoJson = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {"name": "United States"},
                        "geometry": {"type": "Polygon", "coordinates": [[[-158, 22], [-158, 50], [-68, 50], [-68, 22], [-158, 22]]]}
                    },
                    {
                        "type": "Feature", 
                        "properties": {"name": "China"},
                        "geometry": {"type": "Polygon", "coordinates": [[[73, 18], [135, 18], [135, 54], [73, 54], [73, 18]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Germany"}, 
                        "geometry": {"type": "Polygon", "coordinates": [[[5, 47], [15, 47], [15, 55], [5, 55], [5, 47]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "France"},
                        "geometry": {"type": "Polygon", "coordinates": [[[-5, 42], [8, 42], [8, 51], [-5, 51], [-5, 42]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Japan"},
                        "geometry": {"type": "Polygon", "coordinates": [[[129, 31], [146, 31], [146, 46], [129, 46], [129, 31]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Italy"},
                        "geometry": {"type": "Polygon", "coordinates": [[[6, 36], [19, 36], [19, 47], [6, 47], [6, 36]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Brazil"},
                        "geometry": {"type": "Polygon", "coordinates": [[[-74, -34], [-34, -34], [-34, 5], [-74, 5], [-74, -34]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "India"},
                        "geometry": {"type": "Polygon", "coordinates": [[[68, 6], [97, 6], [97, 37], [68, 37], [68, 6]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Canada"},
                        "geometry": {"type": "Polygon", "coordinates": [[[-141, 42], [-52, 42], [-52, 84], [-141, 84], [-141, 42]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "Australia"},
                        "geometry": {"type": "Polygon", "coordinates": [[[113, -44], [154, -44], [154, -10], [113, -10], [113, -44]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "United Kingdom"},
                        "geometry": {"type": "Polygon", "coordinates": [[[-8, 50], [2, 50], [2, 61], [-8, 61], [-8, 50]]]}
                    },
                    {
                        "type": "Feature",
                        "properties": {"name": "South Korea"},
                        "geometry": {"type": "Polygon", "coordinates": [[[124, 33], [131, 33], [131, 39], [124, 39], [124, 33]]]}
                    }
                ]
            };
            
            echarts.registerMap('world', simplifiedWorldGeoJson);
            
            // Country data with BGM type information
            const countryData = [
                {name: 'United States', value: 4250, bgmType: 'Pop Music', percentage: 35},
                {name: 'China', value: 3890, bgmType: 'Electronic', percentage: 42},
                {name: 'Germany', value: 2650, bgmType: 'Classical', percentage: 38},
                {name: 'France', value: 2180, bgmType: 'Jazz', percentage: 28},
                {name: 'Japan', value: 1920, bgmType: 'Electronic', percentage: 45},
                {name: 'Italy', value: 1650, bgmType: 'Classical', percentage: 41},
                {name: 'Brazil', value: 1420, bgmType: 'Pop Music', percentage: 33},
                {name: 'India', value: 1280, bgmType: 'Folk', percentage: 39},
                {name: 'Canada', value: 980, bgmType: 'Pop Music', percentage: 31},
                {name: 'Australia', value: 850, bgmType: 'Rock', percentage: 29},
                {name: 'United Kingdom', value: 1850, bgmType: 'Rock', percentage: 34},
                {name: 'South Korea', value: 1650, bgmType: 'Electronic', percentage: 48}
            ];
            
            const globalMapOption = {
                title: {
                    text: '全球BGM类型分布地图',
                    left: 'center',
                    top: '2%',
                    textStyle: {
                        fontSize: 18,
                        fontWeight: 'bold',
                        color: '#2c3e50'
                    }
                },
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    borderColor: '#ccc',
                    borderWidth: 1,
                    textStyle: {
                        color: '#fff',
                        fontSize: 14
                    },
                    formatter: function(params) {
                        if (params.data && params.data.value !== undefined) {
                            const data = params.data;
                            return `
                                <div style="padding: 8px;">
                                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">${params.name}</div>
                                    <div style="margin-bottom: 4px;">📊 总帖子数: <span style="color: #4ecdc4;">${data.value.toLocaleString()}</span></div>
                                    <div style="margin-bottom: 4px;">🎵 主要BGM类型: <span style="color: ${bgmTypeColors[data.bgmType] || '#fff'};">${data.bgmType}</span></div>
                                    <div>📈 占比: <span style="color: #f9ca24;">${data.percentage}%</span></div>
                                </div>
                            `;
                        }
                        return params.name + ': 暂无数据';
                    }
                },
                legend: {
                    orient: 'horizontal',
                    left: 'center',
                    top: '8%',
                    data: Object.keys(bgmTypeColors),
                    textStyle: {
                        color: '#333',
                        fontSize: 12
                    },
                    itemWidth: 20,
                    itemHeight: 14,
                    formatter: function(name) {
                        return name;
                    }
                },
                series: [
                    {
                        name: 'BGM类型分布',
                        type: 'map',
                        map: 'world',
                        roam: true,
                        zoom: 1.2,
                        center: [0, 20],
                        data: countryData,
                        itemStyle: {
                            areaColor: function(params) {
                                if (params.data && params.data.bgmType) {
                                    return bgmTypeColors[params.data.bgmType] || '#f3f3f3';
                                }
                                return '#f3f3f3';
                            },
                            borderColor: '#fff',
                            borderWidth: 1,
                            shadowColor: 'rgba(0, 0, 0, 0.2)',
                            shadowBlur: 10
                        },
                        emphasis: {
                            itemStyle: {
                                areaColor: function(params) {
                                    if (params.data && params.data.bgmType) {
                                        // Lighten the color on hover
                                        const color = bgmTypeColors[params.data.bgmType] || '#f3f3f3';
                                        return color + 'CC'; // Add transparency
                                    }
                                    return '#e6f3ff';
                                },
                                borderColor: '#333',
                                borderWidth: 2,
                                shadowColor: 'rgba(0, 0, 0, 0.5)',
                                shadowBlur: 20
                            },
                            label: {
                                show: true,
                                color: '#000',
                                fontSize: 12,
                                fontWeight: 'bold'
                            }
                        },
                        select: {
                            itemStyle: {
                                areaColor: '#ffd700'
                            }
                        }
                    }
                ]
            };
            globalMapChart.setOption(globalMapOption);
            
            // Store chart reference for resize
            window.globalMapChart = globalMapChart;
        }

        // Top Countries Chart
        const topCountriesChart = echarts.init(document.getElementById('topCountries'));
        const topCountriesOption = {
                tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' }
            },
            xAxis: {
                type: 'value',
                name: 'Number of Posts'
            },
            yAxis: {
                type: 'category',
                data: ['Australia', 'Canada', 'India', 'Brazil', 'Italy', 'Japan', 'France', 'Germany', 'China', 'United States']
            },
            series: [
                {
                    name: 'Posts',
                    type: 'bar',
                    data: [850, 980, 1280, 1420, 1650, 1920, 2180, 2650, 3890, 4250],
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                            { offset: 0, color: '#667eea' },
                            { offset: 1, color: '#764ba2' }
                        ])
                    },
                    label: {
                        show: true,
                        position: 'right',
                        formatter: '{c}'
                    }
                }
            ]
        };
        topCountriesChart.setOption(topCountriesOption);

        // Regional Preferences Chart
        const regionalPreferencesChart = echarts.init(document.getElementById('regionalPreferences'));
        const regionalPreferencesOption = {
                tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' }
            },
            legend: {
                data: ['Pop Music', 'Electronic', 'Classical', 'Jazz', 'Rock'],
                top: '10%'
            },
            xAxis: {
                type: 'category',
                data: ['North America', 'Asia', 'Europe', 'South America', 'Africa', 'Oceania']
            },
            yAxis: {
                type: 'value',
                name: 'Percentage (%)'
            },
            series: [
                {
                    name: 'Pop Music',
                    type: 'bar',
                    stack: 'total',
                    data: [35, 25, 20, 40, 30, 32],
                    itemStyle: { color: '#ff6b6b' }
                },
                {
                    name: 'Electronic',
                    type: 'bar',
                    stack: 'total',
                    data: [25, 35, 25, 20, 25, 28],
                    itemStyle: { color: '#4ecdc4' }
                },
                {
                    name: 'Classical',
                    type: 'bar',
                    stack: 'total',
                    data: [15, 15, 35, 15, 20, 18],
                    itemStyle: { color: '#45b7d1' }
                },
                {
                    name: 'Jazz',
                    type: 'bar',
                    stack: 'total',
                    data: [15, 10, 15, 15, 15, 12],
                    itemStyle: { color: '#f9ca24' }
                },
                {
                    name: 'Rock',
                    type: 'bar',
                    stack: 'total',
                    data: [10, 15, 5, 10, 10, 10],
                    itemStyle: { color: '#6c5ce7' }
                }
            ]
        };
        regionalPreferencesChart.setOption(regionalPreferencesOption);

        // Cultural Trends Chart
        const culturalTrendsChart = echarts.init(document.getElementById('culturalTrends'));
        const culturalTrendsOption = {
                tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['Western Pop', 'Asian Electronic', 'European Classical', 'Latin Rhythms', 'African Beats'],
                top: '10%'
            },
            xAxis: {
                type: 'category',
                data: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun']
            },
            yAxis: {
                type: 'value',
                name: 'Popularity Index'
            },
            series: [
                {
                    name: 'Western Pop',
                    type: 'line',
                    data: [85, 87, 89, 91, 93, 95],
                    itemStyle: { color: '#e74c3c' },
                    lineStyle: { width: 3 }
                },
                {
                    name: 'Asian Electronic',
                    type: 'line',
                    data: [70, 75, 78, 82, 85, 88],
                    itemStyle: { color: '#3498db' },
                    lineStyle: { width: 3 }
                },
                {
                    name: 'European Classical',
                    type: 'line',
                    data: [65, 66, 68, 70, 71, 73],
                    itemStyle: { color: '#27ae60' },
                    lineStyle: { width: 3 }
                },
                {
                    name: 'Latin Rhythms',
                    type: 'line',
                    data: [60, 62, 65, 68, 70, 72],
                    itemStyle: { color: '#f39c12' },
                    lineStyle: { width: 3 }
                },
                {
                    name: 'African Beats',
                    type: 'line',
                    data: [45, 48, 52, 55, 58, 62],
                    itemStyle: { color: '#9b59b6' },
                    lineStyle: { width: 3 }
                }
            ]
        };
        culturalTrendsChart.setOption(culturalTrendsOption);

        // Resize charts on window resize
        window.addEventListener('resize', function() {
            if (window.globalMapChart) {
                window.globalMapChart.resize();
            }
            topCountriesChart.resize();
            regionalPreferencesChart.resize();
            culturalTrendsChart.resize();
        });

        // Download functions
        function downloadChart(chartId) {
            let chart;
            switch(chartId) {
                case 'globalMap':
                    chart = window.globalMapChart;
                    break;
                case 'topCountries':
                    chart = topCountriesChart;
                    break;
                case 'regionalPreferences':
                    chart = regionalPreferencesChart;
                    break;
                case 'culturalTrends':
                    chart = culturalTrendsChart;
                    break;
            }
            
            if (chart) {
                const url = chart.getDataURL({
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });
                const link = document.createElement('a');
                link.href = url;
                link.download = `${chartId}_chart.png`;
                link.click();
            }
        }

        function downloadTable(tableId) {
            const table = document.getElementById(tableId);
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) {
                    let cellText = cols[j].innerText;
                    // Remove badges and flags for CSV
                    if (cols[j].querySelector('.region-badge')) {
                        cellText = cols[j].querySelector('.region-badge').innerText;
                    }
                    if (cols[j].querySelector('.country-name')) {
                        cellText = cols[j].querySelector('.country-name').innerText.trim();
                    }
                    row.push('"' + cellText + '"');
                }
                csv.push(row.join(','));
            }
            
            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            downloadLink.download = `${tableId}_data.csv`;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.click();
        }

        function downloadMetrics() {
            const metrics = [
                ['Metric', 'Value'],
                ['Countries Analyzed', '45'],
                ['Continents', '5'],
                ['Total Global Posts', '18.7K'],
                ['Global Coverage', '92.3%']
            ];
            
            const csv = metrics.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
            const csvFile = new Blob([csv], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            downloadLink.download = 'country_metrics.csv';
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.click();
        }
    </script>
</body>
</html>