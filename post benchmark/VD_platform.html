<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Duration Platform Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .stat-label {
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-change {
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        
        .chart-section {
            background: #fff;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .chart-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-title {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #f8f9fa;
        }
        
        .btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        
        .download-btn:hover {
            background: #218838;
        }
        
        .chart-container {
            height: 400px;
            padding: 20px;
        }
        
        .duration-selector {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        .table-section {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-container {
            overflow-x: auto;
            padding: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .merged-cell {
            background: #e9ecef;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Statistics Section -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Videos</div>
                <div class="stat-value">18,742</div>
                <div class="stat-change positive">+12.3% QoQ</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Average Duration</div>
                <div class="stat-value">2.4 min</div>
                <div class="stat-change positive">+8.7% QoQ</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Most Popular Duration</div>
                <div class="stat-value">15~30s</div>
                <div class="stat-change">4,892 videos</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Highest Engagement Duration</div>
                <div class="stat-value">30~60s</div>
                <div class="stat-change positive">14.2% rate</div>
            </div>
        </div>

        <!-- Box Plot Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">Video Duration Distribution by Platform</div>
                <div class="chart-controls">
                    <button class="btn download-btn" onclick="downloadChart('boxPlotChart')">Download</button>
                </div>
            </div>
            <div class="chart-container">
                <div id="boxPlotChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>

        <!-- Combined Stacked Bar Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">Platform and Duration Analysis</div>
                <div class="chart-controls">
                    <button class="btn active" onclick="switchDataType('posts')">Posts</button>
                    <button class="btn" onclick="switchDataType('engagement')">Engagement</button>
                    <button class="btn" onclick="switchDataType('views')">Views</button>
                    <button class="btn download-btn" onclick="downloadChart('combinedChart')">Download</button>
                </div>
            </div>
            <div class="chart-container">
                <div id="combinedChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>

        <!-- Trend Line Charts Section -->
        <div class="chart-section">
            <div class="chart-header">
                <div class="chart-title">Trend Analysis by Duration</div>
                <div class="chart-controls">
                    <button class="btn active" onclick="switchTrendMetric('posts')">Posts</button>
                    <button class="btn" onclick="switchTrendMetric('engagement')">Engagement</button>
                    <button class="btn" onclick="switchTrendMetric('views')">Views</button>
                    <button class="btn" onclick="switchTrendMetric('engagementRate')">Engagement Rate</button>
                    <select class="duration-selector" id="trendDurationSelector" onchange="updateTrendByDuration(this.value)">
                        <option value="0~15s">0~15s</option>
                        <option value="15~30s">15~30s</option>
                        <option value="30~60s">30~60s</option>
                        <option value="1~3min">1~3min</option>
                        <option value="3~5min">3~5min</option>
                        <option value="5~10min">5~10min</option>
                        <option value="10~20min">10~20min</option>
                        <option value="20~30min">20~30min</option>
                        <option value="30~60min">30~60min</option>
                        <option value=">60min">>60min</option>
                    </select>
                    <button class="btn download-btn" onclick="downloadChart('trendChart')">Download</button>
                </div>
            </div>
            <div class="chart-container">
                <div id="trendChart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>

        <!-- Data Table Section -->
        <div class="table-section">
            <div class="chart-header">
                <div class="chart-title">Platform Duration Data</div>
                <div class="chart-controls">
                    <button class="btn download-btn" onclick="downloadTable()">Download CSV</button>
                </div>
            </div>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Platform</th>
                            <th>Video Duration</th>
                            <th>Posts</th>
                            <th>Posts QoQ</th>
                            <th>Engagement</th>
                            <th>Engagement QoQ</th>
                            <th>Views</th>
                            <th>Views QoQ</th>
                            <th>Engagement Rate</th>
                            <th>Engagement Rate QoQ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td rowspan="4" class="merged-cell">TikTok</td>
                            <td>0~15s</td>
                            <td>1,234</td>
                            <td class="positive">+12.5%</td>
                            <td>45,678</td>
                            <td class="positive">+8.3%</td>
                            <td>2.3M</td>
                            <td class="positive">+15.2%</td>
                            <td>8.5%</td>
                            <td class="negative">-2.1%</td>
                        </tr>
                        <tr>
                            <td>15~30s</td>
                            <td>1,892</td>
                            <td class="positive">+18.7%</td>
                            <td>68,456</td>
                            <td class="positive">+22.1%</td>
                            <td>3.2M</td>
                            <td class="positive">+28.4%</td>
                            <td>9.2%</td>
                            <td class="positive">+3.8%</td>
                        </tr>
                        <tr>
                            <td>30~60s</td>
                            <td>1,456</td>
                            <td class="positive">+14.2%</td>
                            <td>78,234</td>
                            <td class="positive">+19.6%</td>
                            <td>2.8M</td>
                            <td class="positive">+16.8%</td>
                            <td>12.8%</td>
                            <td class="positive">+4.5%</td>
                        </tr>
                        <tr>
                            <td>1~3min</td>
                            <td>892</td>
                            <td class="positive">+9.8%</td>
                            <td>45,123</td>
                            <td class="positive">+12.4%</td>
                            <td>1.9M</td>
                            <td class="positive">+8.7%</td>
                            <td>11.2%</td>
                            <td class="positive">+2.3%</td>
                        </tr>
                        <tr>
                            <td rowspan="4" class="merged-cell">Instagram</td>
                            <td>0~15s</td>
                            <td>856</td>
                            <td class="positive">+14.2%</td>
                            <td>67,892</td>
                            <td class="positive">+19.6%</td>
                            <td>1.2M</td>
                            <td class="positive">+16.8%</td>
                            <td>12.8%</td>
                            <td class="positive">+4.5%</td>
                        </tr>
                        <tr>
                            <td>15~30s</td>
                            <td>743</td>
                            <td class="positive">+9.8%</td>
                            <td>45,123</td>
                            <td class="positive">+12.4%</td>
                            <td>987K</td>
                            <td class="positive">+8.7%</td>
                            <td>11.2%</td>
                            <td class="positive">+2.3%</td>
                        </tr>
                        <tr>
                            <td>30~60s</td>
                            <td>612</td>
                            <td class="negative">-3.2%</td>
                            <td>34,567</td>
                            <td class="positive">+5.1%</td>
                            <td>756K</td>
                            <td class="positive">+7.9%</td>
                            <td>10.5%</td>
                            <td class="positive">+1.8%</td>
                        </tr>
                        <tr>
                            <td>1~3min</td>
                            <td>445</td>
                            <td class="positive">+7.3%</td>
                            <td>28,934</td>
                            <td class="positive">+11.2%</td>
                            <td>634K</td>
                            <td class="positive">+9.5%</td>
                            <td>9.8%</td>
                            <td class="positive">+1.4%</td>
                        </tr>
                        <tr>
                            <td rowspan="3" class="merged-cell">YouTube</td>
                            <td>1~3min</td>
                            <td>234</td>
                            <td class="positive">+25.3%</td>
                            <td>123,456</td>
                            <td class="positive">+31.2%</td>
                            <td>5.6M</td>
                            <td class="positive">+28.9%</td>
                            <td>6.8%</td>
                            <td class="positive">+2.7%</td>
                        </tr>
                        <tr>
                            <td>3~5min</td>
                            <td>189</td>
                            <td class="positive">+16.7%</td>
                            <td>89,234</td>
                            <td class="positive">+18.5%</td>
                            <td>3.4M</td>
                            <td class="positive">+21.3%</td>
                            <td>7.2%</td>
                            <td class="positive">+1.9%</td>
                        </tr>
                        <tr>
                            <td>5~10min</td>
                            <td>156</td>
                            <td class="positive">+12.8%</td>
                            <td>67,891</td>
                            <td class="positive">+15.4%</td>
                            <td>2.8M</td>
                            <td class="positive">+18.7%</td>
                            <td>6.9%</td>
                            <td class="positive">+1.2%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Sample data
        const platforms = ['TikTok', 'Instagram', 'YouTube', 'Facebook'];
        const durations = ['0~15s', '15~30s', '30~60s', '1~3min', '3~5min', '5~10min', '10~20min', '20~30min', '30~60min', '>60min'];
        const dates = ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06'];

        // Chart instances
        let charts = {};
        let currentChartTypes = {
            combined: 'bar'
        };
        let currentTrendMetric = 'posts';
        let currentDataType = 'posts';
        let allChartData = {};

        // Initialize all charts
        function initCharts() {
            initBoxPlotChart();
            
            // Generate and store all data
            allChartData.posts = generatePostsData();
            allChartData.engagement = generateEngagementData();
            allChartData.views = generateViewsData();
            
            initCombinedChart('posts');
            initTrendChart('posts');
        }

        // Box Plot Chart
        function initBoxPlotChart() {
            const chart = echarts.init(document.getElementById('boxPlotChart'));
            
            // Generate box plot data for each platform
            const boxData = platforms.map(platform => {
                // Generate sample duration data (in seconds for calculation)
                const durationValues = [];
                durations.forEach((duration, index) => {
                    const count = Math.floor(Math.random() * 500) + 100;
                    let avgDuration;
                    switch(duration) {
                        case '0~15s': avgDuration = 7.5; break;
                        case '15~30s': avgDuration = 22.5; break;
                        case '30~60s': avgDuration = 45; break;
                        case '1~3min': avgDuration = 120; break;
                        case '3~5min': avgDuration = 240; break;
                        case '5~10min': avgDuration = 450; break;
                        case '10~20min': avgDuration = 900; break;
                        case '20~30min': avgDuration = 1500; break;
                        case '30~60min': avgDuration = 2700; break;
                        case '>60min': avgDuration = 4200; break;
                    }
                    for(let i = 0; i < count; i++) {
                        durationValues.push(avgDuration + (Math.random() - 0.5) * avgDuration * 0.4);
                    }
                });
                
                durationValues.sort((a, b) => a - b);
                const q1 = durationValues[Math.floor(durationValues.length * 0.25)];
                const median = durationValues[Math.floor(durationValues.length * 0.5)];
                const q3 = durationValues[Math.floor(durationValues.length * 0.75)];
                const min = durationValues[0];
                const max = durationValues[durationValues.length - 1];
                
                return [min, q1, median, q3, max];
            });

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const data = params.data;
                        const qoqChange = (Math.random() * 20 - 10).toFixed(1);
                        return `Platform: ${platforms[params.dataIndex]}<br/>
                                Min: ${data[0].toFixed(1)} sec<br/>
                                Q1: ${data[1].toFixed(1)} sec<br/>
                                Median: ${data[2].toFixed(1)} sec<br/>
                                Q3: ${data[3].toFixed(1)} sec<br/>
                                Max: ${data[4].toFixed(1)} sec<br/>
                                QoQ Change: ${qoqChange > 0 ? '+' : ''}${qoqChange}%`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: platforms,
                    axisLabel: {
                        rotate: 0
                    }
                },
                yAxis: {
                    type: 'value',
                    name: 'Duration (seconds)',
                    axisLabel: {
                        formatter: function(value) {
                            return value.toFixed(0);
                        }
                    }
                },
                series: [{
                    name: 'Duration Distribution',
                    type: 'boxplot',
                    data: boxData,
                    itemStyle: {
                        color: '#007bff'
                    }
                }]
            };

            chart.setOption(option);
            charts['boxPlotChart'] = chart;
        }

        // Generate sample data for stacked bar charts
        function generatePostsData() {
            return durations.map(duration => {
                const currentData = platforms.map(() => Math.floor(Math.random() * 1000) + 200);
                const previousData = currentData.map(val => Math.floor(val * (0.8 + Math.random() * 0.4)));
                const momChanges = currentData.map((current, index) => {
                    const change = ((current - previousData[index]) / previousData[index] * 100).toFixed(1);
                    return parseFloat(change);
                });
                
                return {
                    name: duration,
                    data: currentData,
                    momChanges: momChanges
                };
            });
        }

        function generateEngagementData() {
            return durations.map(duration => {
                const currentData = platforms.map(() => Math.floor(Math.random() * 50000) + 10000);
                const previousData = currentData.map(val => Math.floor(val * (0.8 + Math.random() * 0.4)));
                const momChanges = currentData.map((current, index) => {
                    const change = ((current - previousData[index]) / previousData[index] * 100).toFixed(1);
                    return parseFloat(change);
                });
                
                return {
                    name: duration,
                    data: currentData,
                    momChanges: momChanges
                };
            });
        }

        function generateViewsData() {
            return durations.map(duration => {
                const currentData = platforms.map(() => Math.floor(Math.random() * 5000000) + 500000);
                const previousData = currentData.map(val => Math.floor(val * (0.8 + Math.random() * 0.4)));
                const momChanges = currentData.map((current, index) => {
                    const change = ((current - previousData[index]) / previousData[index] * 100).toFixed(1);
                    return parseFloat(change);
                });
                
                return {
                    name: duration,
                    data: currentData,
                    momChanges: momChanges
                };
            });
        }

        // Combined Chart
        function initCombinedChart(dataType) {
            const chart = echarts.init(document.getElementById('combinedChart'));
            const data = allChartData[dataType];
            
            const series = data.map(item => ({
                name: item.name,
                type: 'bar',
                stack: 'total',
                data: item.data,
                momChanges: item.momChanges
            }));

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        let result = `${params[0].axisValue}<br/>`;
                        params.forEach(param => {
                            const momChange = param.data.momChanges ? param.data.momChanges[param.dataIndex] : 
                                            (param.seriesName && charts['combinedChart'] && charts['combinedChart'].momChanges) ? 
                                            charts['combinedChart'].momChanges[param.seriesName][param.dataIndex] : 
                                            (Math.random() * 20 - 10).toFixed(1);
                            result += `${param.marker}${param.seriesName}: ${param.value.toLocaleString()}<br/>`;
                            result += `QoQ: ${momChange > 0 ? '+' : ''}${momChange}%<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: data.map(item => item.name),
                    top: 10
                },
                xAxis: {
                    type: 'category',
                    data: platforms
                },
                yAxis: {
                    type: 'value',
                    name: dataType.charAt(0).toUpperCase() + dataType.slice(1)
                },
                series: series
            };

            chart.setOption(option);
            charts['combinedChart'] = chart;
            
            // Store MoM changes for tooltip
            charts['combinedChart'].momChanges = {};
            data.forEach(item => {
                charts['combinedChart'].momChanges[item.name] = item.momChanges;
            });
        }

        // Switch data type in combined chart
        function switchDataType(dataType) {
            currentDataType = dataType;
            
            // Update button states - find buttons in the Platform and Duration Analysis section
            const chartSection = document.querySelector('#combinedChart').closest('.chart-section');
            const buttons = chartSection.querySelectorAll('.btn:not(.download-btn)');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the correct button
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase() === dataType) {
                    btn.classList.add('active');
                }
            });
            
            initCombinedChart(dataType);
        }

        // Toggle combined chart type
        function toggleCombinedChartType(type) {
            const buttons = document.querySelectorAll('#combinedChart').parentNode.parentNode.querySelectorAll('.btn:not(.download-btn)');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'line') {
                initCombinedTrendChart(currentDataType);
            } else {
                initCombinedChart(currentDataType);
            }
            
            currentChartTypes.combined = type;
        }

        function initCombinedTrendChart(metric) {
            const chart = charts['combinedChart'];
            
            const series = durations.slice(0, 6).map(duration => {
                const data = dates.map(() => {
                    switch(metric) {
                        case 'posts': return Math.floor(Math.random() * 500) + 100;
                        case 'engagement': return Math.floor(Math.random() * 20000) + 5000;
                        case 'views': return Math.floor(Math.random() * 2000000) + 200000;
                    }
                });
                
                return {
                    name: duration,
                    type: 'line',
                    data: data,
                    smooth: true
                };
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = `${params[0].axisValue}<br/>`;
                        params.forEach(param => {
                            const qoqChange = (Math.random() * 20 - 10).toFixed(1);
                            result += `${param.marker}${param.seriesName}: ${param.value.toLocaleString()}<br/>`;
                            result += `QoQ: ${qoqChange > 0 ? '+' : ''}${qoqChange}%<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: durations.slice(0, 6),
                    top: 10
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    name: metric.charAt(0).toUpperCase() + metric.slice(1)
                },
                series: series
            };

            chart.setOption(option);
        }

        // Trend Chart
        // Trend Analysis Chart
        function initTrendChart(metric = 'posts') {
            const chart = echarts.init(document.getElementById('trendChart'));
            charts['trendChart'] = chart;
            updateTrendChart(metric, 'all');
        }

        function updateTrendChart(metric, durationFilter = 'all') {
            const chart = charts['trendChart'];
            if (!chart) return;
            
            let filteredPlatforms = platforms;
            if (durationFilter !== 'all') {
                // When a specific duration is selected, show all platforms for that duration
                filteredPlatforms = platforms;
            }
            
            const series = filteredPlatforms.map(platform => {
                const data = dates.map(() => {
                    switch(metric) {
                        case 'posts': return Math.floor(Math.random() * 500) + 100;
                        case 'engagement': return Math.floor(Math.random() * 20000) + 5000;
                        case 'views': return Math.floor(Math.random() * 2000000) + 200000;
                        case 'engagementRate': return (Math.random() * 10 + 2).toFixed(2);
                        default: return Math.floor(Math.random() * 500) + 100;
                    }
                });
                return {
                    name: platform,
                    type: 'line',
                    data: data,
                    smooth: true
                };
            });

            // Calculate total average as a straight line
            const totalSum = series.reduce((acc, s) => {
                return acc + s.data.reduce((sum, val) => sum + parseFloat(val), 0);
            }, 0);
            const totalCount = series.length * dates.length;
            const overallAverage = (totalSum / totalCount).toFixed(metric === 'engagementRate' ? 2 : 0);
            
            // Create straight line with the same value for all dates
            const avgData = dates.map(() => overallAverage);

            series.push({
                name: 'Total Average',
                type: 'line',
                data: avgData,
                lineStyle: {
                    type: 'dashed',
                    color: '#999',
                    width: 2
                },
                itemStyle: {
                    color: '#999'
                },
                symbol: 'none'
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = `${params[0].axisValue}<br/>`;
                        if (durationFilter !== 'all') {
                            result += `Duration: ${durationFilter}<br/>`;
                        }
                        params.forEach(param => {
                            const qoqChange = (Math.random() * 20 - 10).toFixed(1);
                            const unit = metric === 'engagementRate' ? '%' : '';
                            result += `${param.marker}${param.seriesName}: ${param.value}${unit}<br/>`;
                            if (param.seriesName !== 'Total Average') {
                                result += `QoQ: ${qoqChange > 0 ? '+' : ''}${qoqChange}%<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: [...filteredPlatforms, 'Total Average'],
                    top: 10
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    name: metric === 'engagementRate' ? 'Engagement Rate (%)' : metric.charAt(0).toUpperCase() + metric.slice(1)
                },
                series: series
            };

            chart.setOption(option);
        }

        // Chart type toggle functions
        function toggleChartType(chartType, type) {
            const chartId = chartType + 'Chart';
            const buttons = document.querySelectorAll(`#${chartId}`).parentNode.parentNode.querySelectorAll('.btn:not(.download-btn)');
            
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (type === 'line') {
                // Convert to trend line chart
                initTrendLineChart(chartId, chartType);
            } else {
                // Convert back to stacked bar chart
                let data;
                switch(chartType) {
                    case 'posts': data = generatePostsData(); break;
                    case 'engagement': data = generateEngagementData(); break;
                    case 'views': data = generateViewsData(); break;
                }
                initStackedBarChart(chartId, chartType.charAt(0).toUpperCase() + chartType.slice(1), data);
            }
            
            currentChartTypes[chartType] = type;
        }

        function initTrendLineChart(chartId, metric) {
            const chart = charts[chartId];
            
            const series = durations.slice(0, 6).map(duration => {
                const data = dates.map(() => {
                    switch(metric) {
                        case 'posts': return Math.floor(Math.random() * 500) + 100;
                        case 'engagement': return Math.floor(Math.random() * 20000) + 5000;
                        case 'views': return Math.floor(Math.random() * 2000000) + 200000;
                    }
                });
                
                return {
                    name: duration,
                    type: 'line',
                    data: data,
                    smooth: true
                };
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = `${params[0].axisValue}<br/>`;
                        params.forEach(param => {
                            const qoqChange = (Math.random() * 20 - 10).toFixed(1);
                            result += `${param.marker}${param.seriesName}: ${param.value.toLocaleString()}<br/>`;
                            result += `QoQ: ${qoqChange > 0 ? '+' : ''}${qoqChange}%<br/>`;
                        });
                        return result;
                    }
                },
                legend: {
                    data: durations.slice(0, 6),
                    top: 10
                },
                xAxis: {
                    type: 'category',
                    data: dates
                },
                yAxis: {
                    type: 'value',
                    name: metric.charAt(0).toUpperCase() + metric.slice(1)
                },
                series: series
            };

            chart.setOption(option);
        }

        // Trend metric switching
        function switchTrendMetric(metric) {
            // Update button states - find buttons in the Trend Analysis section
            const chartSection = document.querySelector('#trendChart').closest('.chart-section');
            const buttons = chartSection.querySelectorAll('.btn:not(.download-btn)');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find and activate the correct button
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase() === metric.toLowerCase() || 
                    (metric === 'engagementRate' && btn.textContent === 'Engagement Rate')) {
                    btn.classList.add('active');
                }
            });
            
            currentTrendMetric = metric;
            const duration = document.getElementById('trendDurationSelector').value;
            updateTrendChart(metric, duration);
        }

        function updateTrendByDuration(duration) {
            updateTrendChart(currentTrendMetric, duration);
        }

        // Download functions
        function downloadChart(chartId) {
            const chart = charts[chartId];
            if (chart) {
                const url = chart.getDataURL({
                    type: 'png',
                    pixelRatio: 2,
                    backgroundColor: '#fff'
                });
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `${chartId}_chart.png`;
                link.click();
            }
        }

        function downloadTable() {
            const table = document.getElementById('dataTable');
            let csv = [];
            
            // Get headers
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            csv.push(headers.join(','));
            
            // Get data rows
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = Array.from(row.cells).map(cell => {
                    return `"${cell.textContent.replace(/"/g, '""')}"`;
                });
                csv.push(cells.join(','));
            });
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'platform_duration_data.csv';
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Resize charts on window resize
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chart => {
                if (chart && chart.resize) {
                    chart.resize();
                }
            });
        });

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
        });
    </script>
</body>
</html>
